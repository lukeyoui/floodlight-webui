<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="description" content=""/>
    <meta name="author" content=""/>


    <!-- Bootstrap Core CSS -->
    <link href="../bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- DataTables CSS -->
    <link href="../bower_components/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.css"
          rel="stylesheet"/>

    <!-- DataTables Responsive CSS -->
    <link href="../bower_components/datatables-responsive/css/dataTables.responsive.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link href="../dist/css/sb-admin-2.css" rel="stylesheet"/>

    <!-- Custom Fonts -->
    <link href="../bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>

    <link type="text/css" rel="stylesheet" src="../bower_components/qtip/jquery.qtip.css"></link>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style type="text/css">
        #cy {
            flex: 1;
            height: calc(100vh - 200px);
        }
        body, html, #wrapper {
            height: auto;
        }
        body.visualizing #clearFlow {
            visibility: visible;
        }
        #page-wrapper {
            height: auto;
        }
        .qtip.qtip-switch {
            max-width: 825px;
	        min-width: 200px;
        }
        .qtip.qtip-host {
            max-width: 350px;
	        min-width: 300px;
        }
        .qtip.qtip-link{
            max-width: 350px;
            min-width: 350px;
        }
        .datatable-center {
            text-align: center;
        }
        #clearFlow {
            position: absolute;
            right: 0;
            top: 0;
            margin-top: 150px;
            margin-right: 25px;
            visibility: hidden;
        }
    </style>
</head>
<body>
    <div id="cy"></div>
    <button id="clearFlow" type="button" class="btn btn-danger btn-lg">Clear</button>

<!-- Bootstrap Core JavaScript -->
<script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

<!-- DataTables JavaScript -->
<script src="../bower_components/datatables/media/js/jquery.dataTables.min.js"></script>
<script src="../bower_components/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.min.js"></script>

<!-- Page-Level Demo Scripts - Tables - Use for reference -->
<script src="../js/querystringparser.js"></script>
<script src="../js/jquery.cookie.js"></script>
<script src="../js/common.js"></script>

<!-- Custom scripts to load in HTML -->
<script src="../bower_components/cytoscape/dist/cytoscape.js"></script>
<script src="../bower_components/qtip2/jquery.qtip.min.js"></script>
<link href="../bower_components/qtip2/jquery.qtip.min.css" rel="stylesheet" type="text/css"/>
<script src="../bower_components/cytoscape-qtip/cytoscape-qtip.js"></script>

<script type="text/javascript">
    /*
     * These cookies are set on the login page at login.html.
     * They are simply the IP address of your controller and the REST api port.
     */

    var ipaddress = $.cookie('cip');
    if (ipaddress == null || ipaddress == "") window.location.href = "login.html";
    var restport = $.cookie('cport');
    if (restport == null || restport == "") window.location.href = "login.html";

    /* Declare some constant values for the types of nodes we can add */
    var NODE_SWITCH = "SWITCH";
    var NODE_HOST = "HOST";

    /* Define some constants for background colour */
    var SWITCH_BG = "#CE4345";
    var HOST_BG = "#589DFE";
    var DEFAULT_EDGE_COLOR = "#000000";
    var BLOCKED_EDGE_COLOR = "#444444";

    /* Constant for default line weights */
    var DEFAULT_EDGE_WEIGHT = 10;
    var MIN_EDGE_WEIGHT = 5;
    var MAX_EDGE_WEIGHT = 15;

    /* Constants for edge opacity */
    var DEFAULT_EDGE_OPACITY = 0.80;
    var BLOCKED_EDGE_OPACITY = 0.40;

    /* Constant for length of MAC in string form */
    var MAC_LEN = 17;

    /* Placeholder for the graph */
    var cyto = null;

    /* Cache for bandwidth values */
    var bandwidth = [];

    /* TODO: Need a method to fill these values, it should probably
     *       use the websocket to send a request? maybe get rid of them
     *       and pass directly into a creation function
     */
    var nodes = [];
    var edges = [];

    /*
     * This function draws the network and assigns actions to it as well.
     */
    /* TODO: I would like to delete this method entirely maybe even add
             the loading into the ready function */
    function draw() {
        cyto = cytoscape({
            container: document.getElementById("cy"),
            elements: {
                nodes: nodes,
                edges: edges
            },
            /* Set the CSS styles for the graph */
            style: cytoscape.stylesheet()
                /* Node CSS */
                .selector('node').css({
                    /* Select the shape of the node based off the type */
                    'shape': function(ele) {
                        if (ele.data('type') == NODE_SWITCH) {
                            return "roundrectangle";
                        } else {
                            return "ellipse";
                        }
                    },

                    /* Set the background colour based on the type */
                    'background-color': function(ele) {
                        if (ele.data('type') == NODE_SWITCH) {
                            return SWITCH_BG;
                        } else {
                            return HOST_BG;
                        }
                    },

                    /* Set the background image using rendered FA icons */
                    'background-image': function(ele) {
                        if (ele.data('type') == NODE_SWITCH) {
                            return ("../bower_components/Font-Awesome-SVG-PNG/black/png/128/random.png");
                        } else {
                            return ("../bower_components/Font-Awesome-SVG-PNG/black/png/128/desktop.png");
                        }
                    },

                    /* Need to scale the background image for hosts more
                     * than the one for switches because of the shape
                     */
                    'background-width': function(ele) {
                        if (ele.data('type') == NODE_SWITCH) {
                            return '80%';
                        } else {
                            return '70%';
                        }
                    },


                    /* Same for the vertical position */
                    'background-position-y': function(ele) {
                        if (ele.data('type') == NODE_SWITCH) {
                            return '50%';
                        } else {
                            return '60%';
                        }
                    },

                    /* Same for the height */
                    'background-height': function(ele) {
                        if (ele.data('type') == NODE_SWITCH) {
                            return '80%';
                        } else {
                            return '70%';
                        }
                    },

                    /* Change border color by background color */
                    'border-color': function(ele) {
                        if (ele.data('type') == NODE_SWITCH) {
                            return '#510001';
                        } else {
                            return '#08264B';
                        }
                    },
                    'border-width': 5,
                    'border-opacity': 0.6,
                    'font-family': 'FontAwesome',
                    'font-style': 'normal',
                    'font-size': '20',
                    'text-valign': 'bottom',
                    'text-wrap': 'wrap',
                    'height': 64,
                    'width': 64
                })
                .selector('edge').css({
                    'width': function(ele) {
                        return (ele.data('weight'));
                    },
                    'line-color': function(ele) {
                        return (ele.data('color'));
                    },
                    'opacity': function(ele) {
                        return (ele.data('opacity'));
                    }
                 })
                 .selector('node.not-path').css({
                     'opacity': 0.3,
                     'z-index': 0
                 })
                 .selector('node.path').css({
                     'opacity': 1,
                     'z-index': 1
                 })
                 .selector('edge.not-path').css({
                     'opacity': 0.1,
                     'z-index': 0
                 })
                 .selector('edge.path').css({
                     'opacity': DEFAULT_EDGE_OPACITY,
                     'z-index': 1
                 }),
            minZoom: 0.5,
            maxZoom: 5,
            wheelSensitivity: 0.2,
            boxSelectionEnabled: true,
            ready: function() {}
        });
        top.cyto = cyto;
    }

    function loadSwitches() {
        /**
         * Loads the switches from the controller and adds them
         * to the cytoscape graph.
         */
        $.ajax({
            url: "http://" + ipaddress + ":" + restport + "/wm/core/controller/switches/json",

            /* On success add each switch as a node in the graph */
            success: function (data) {
                /* Add all the nodes from the JSON into a list */
                var nodes = [];
                for (var i = 0; i < data.length; i++) {
                    nodes.push({
                        group: "nodes",
                        data: {
                            id: data[i]["switchDPID"],
                            name: data[i]["switchDPID"],
                            type: NODE_SWITCH
                        }
                    });
                }

                /* Add the list to the cytoscape graph */
                cyto.add(nodes);

                /* Load internal links */
                loadInternalLinks();

                /* After everything has been added load the downed links */
                loadBlockedLinks();

                /* Add tool-tips that appear on clicks */
                cyto.on("tap", "node[type = 'SWITCH']", function (event) {
                    var src = event.target.id();
                    $.cookie("curSID", src, {expires: 1});
                    event.target.qtip({
                        content: function (event, api) {
                            $.ajax({
                                url: "switchpopup.html",
                                dataType: "html",
                                success: function(html) {
                                    var $html = $('<div/>', {html: html});
                                    api.set('content.text', $html.html());
                                },
                                error: function (jqXHR, textStatus, errorThrown) {
                                    console.error(jqXHR.responseText);
                                }
                            });
                        },
                        overwrite: false,
                        show: {
                            solo: true
                        },
                        hide: {
                            fixed: true,
                            when: {
                                event: 'click'
                            }
                        },
                        events: {
                            /*
                            * When told to hide, we should just destroy the pop-up so we can
                            * re-create it later (so that DataTable does not complain)
                            */
                            hide: function(event, api) {
                                api.destroy(true);
                            }
                        },
                        position: {
                            my: 'bottom center',
                            at: 'top center'
                        },
                        style: {
                            classes: 'qtip-bootstrap qtip-switch',
                            tip: {
                                width: 16,
                                height: 8
                            }
                        }
                    }, event);
                });
            },

            /* If theres an error retrieving the switches log the error */
            error: function (jqXHR, textStatus, errorThrown) {
                console.error(jqXHR.responseText);
                alert('Error: ' + " " + jqXHR.responseText + " \n Status: " +
                      textStatus + " \n Error Thrown: " + errorThrown);
            }
        });
    }

    function loadInternalLinks() {
        /**
         * Loads all the links between switches which are defined as an
         * "internal" link.
         *
         * @see: http://127.0.0.1:8080/wm/topology/links/json
         */

         $.ajax({
             url: "http://" + ipaddress + ":" + restport + "/wm/topology/links/json",

             /* If we can get the data from the REST API */
             success: function (links) {
                 /* For each link we need to add an edge between the switches */
                 edges = [];
                 for (var i = 0; i < links.length; i++) {
                     edges.push({
                         group: "edges",
                         data: {
                             id: links[i]["src-switch"] + "_" + links[i]["dst-switch"],
                             source: links[i]["src-switch"],
                             target: links[i]["dst-switch"],
                             weight: DEFAULT_EDGE_WEIGHT,
                             color: DEFAULT_EDGE_COLOR,
                             opacity: DEFAULT_EDGE_OPACITY,
                             source_port: links[i]["src-port"],
                             target_port: links[i]["dst-port"]
                         }
                     })
                 }

                 /* Add the data to the cytoscape graph */
                 cyto.add(edges);

                 /* Load the hosts */
                 loadHosts();
             }
         });
    }

    function loadHosts() {
        /**
         * Loads all the hosts from the controller and adds them to the
         * cytoscape graph.
         */
        $.ajax({
            url: "http://" + ipaddress + ":" + restport + "/wm/device/",

            success: function (hosts) {
                data = [];
                hosts = hosts.devices;
                for (var i = 0; i < hosts.length; i++) {
                    if (hosts[i]["attachmentPoint"].length > 0) {
                        data.push({
                            group: "nodes",
                            data: {
                                id: hosts[i]["mac"][0],
                                name: hosts[i]["mac"][0],
                                type: NODE_HOST
                            }
                        });
                    }

                    /* Parse all the links between hosts <-> switches */
                    for (var j = 0; j < hosts[i]["attachmentPoint"].length; j++) {
                        data.push({
                            group: "edges",
                            data: {
                                id: hosts[i]["attachmentPoint"][j]["switch"] + "_" + hosts[i]["mac"][0],
                                source: hosts[i]["mac"][0],
                                target: hosts[i]["attachmentPoint"][j]["switch"],
                                weight: DEFAULT_EDGE_WEIGHT,
                                color: DEFAULT_EDGE_COLOR,
                                opacity: DEFAULT_EDGE_OPACITY
                            }
                        })
                    }

                    /* Add the data to the cytoscape graph */
                    cyto.add(data);
                }

                cyto.layout({
                    name: 'cose',
                    gravity: -10,
                    initialTemp: 100000,
                    nodeRepulsion: function(node) {
                        return 100000;
                    },
                    fit: true
                }).run();

                /* Add the edge pop-up */
                cyto.on("tap", "edge", function (event) {
                    /*
                     * Use the data stored on the edge to set the values
                     * for the source and destination addresses
                     */
                    $.cookie("popupLinkSrc", event.target.data("source"), {expires: 1});
                    $.cookie("popupLinkDst", event.target.data("target"), {expires: 1});
                    $.cookie("popupLinkSrcPort", event.target.data("source_port"), {expires: 1});
                    $.cookie("popupLinkDstPort", event.target.data("target_port"), {expires: 1});
                    $.cookie("popupLinkBlockable",
                             (typeof event.target.data("source_port") == "undefined" ||
                              typeof event.target.data("target_port") == "undefined") ? false : true,
                             {expires: 1});

                    event.target.qtip({
                        content: function (event, api) {
                            $.ajax({
                                url: 'linkpopup.html',
                                dataType: "html",
                                success: function(html) {
                                    /* Parse HTML string into real HTML and add it to window */
                                    var $html = $('<div/>', {html: html});
                                    api.set('content.text', $html.html());
                                }
                            });
                        },
                        show: {
                            solo: true
                        },
                        hide: {
                            fixed: true,
                            when: {
                                event: 'click'
                            }
                        },
                        events: {
                            /*
                            * When told to hide, we should just destroy the pop-up so we can
                            * re-create it later (so that DataTable does not complain)
                            */
                            hide: function(event, api) {
                                api.destroy(true);
                            }
                        },
                        position: {
                            my: 'bottom center',
                            at: 'top center'
                        },
                        style: {
                            classes: 'qtip-bootstrap qtip-link',
                            tip: {
                                width: 16,
                                height: 8
                            }
                        }
                    }, event);
                });

                cyto.on("tap", "node[type = 'HOST']", function (event) {
                    var src = event.target.id();
                    $.cookie("popupMAC", src, {expires: 1});

                    event.target.qtip({
                        content: function (event, api) {
                            /* Load the popup HTML and set it in the QTIP window */
                            $.ajax({
                                url: "hostpopup.html",
                                dataType: "html",
                                success: function(html) {
                                    /* Parse HTML string into real HTML and add it to window */
                                    var $html = $('<div/>', {html: html});
                                    api.set('content.text', $html.html());
                                }
                            });
                        },

                        /* If there was an error log and show pop-up */
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.log(jqXHR.responseText);
                            alert('Error: ' + " " + jqXHR.responseText + " \n Status: " +
                                  textStatus + " \n Error Thrown: " + errorThrown);
                        },

                        overwrite: false,
                        show: {
                            solo: true
                        },
                        hide: {
                            fixed: true,
                            when: {
                                event: 'click'
                            }
                        },
                        events: {
                            /*
                            * When told to hide, we should just destroy the pop-up so we can
                            * re-create it later (so that DataTable does not complain)
                            */
                            hide: function(event, api) {
                                api.destroy(true);
                            }
                        },
                        position: {
                            my: 'bottom center',
                            at: 'top center'
                        },
                        style: {
                            classes: 'qtip-bootstrap qtip-host',
                            tip: {
                                width: 16,
                                height: 8
                            }
                        }
                    }, event);
                });
            }
        });
    }

    function loadBlockedLinks() {
        /**
         * Loads all of the blocked links and sets their colours to gray.
         */
         $.ajax({
             url: "http://" + ipaddress + ":" + restport + "/wm/topology/blockedlinks/json",

             /* If we can get the data from the REST API */
             success: function (links) {
                 /* Need to edit the links to show the block */
                 for (var i = 0; i < links.length; i++) {
                     var id = links[i]["src-switch"] + "_" + links[i]["dst-switch"];
                     cyto.$("edge[id = '" + id + "']").data({
                         color: BLOCKED_EDGE_COLOR,
                         opacity: BLOCKED_EDGE_OPACITY
                     });
                 }
             }
         });
    }

    /* TODO: Need to make add more efficient by only adding once */
    draw();
    loadSwitches();


</script>
</body>
</html>
