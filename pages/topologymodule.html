<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="description" content=""/>
    <meta name="author" content=""/>


    <!-- Bootstrap Core CSS -->
    <link href="../bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- DataTables CSS -->
    <link href="../bower_components/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.css"
          rel="stylesheet"/>

    <!-- DataTables Responsive CSS -->
    <link href="../bower_components/datatables-responsive/css/dataTables.responsive.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link href="../dist/css/sb-admin-2.css" rel="stylesheet"/>

    <!-- Custom Fonts -->
    <link href="../bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>

    <link type="text/css" rel="stylesheet" src="../bower_components/qtip/jquery.qtip.css"></link>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style type="text/css">
        #cy {
            flex: 1;
            height: calc(100vh - 51px);
        }
        body, html, #wrapper {
            height: auto;
        }
        #page-wrapper {
            height: auto;
        }
        .qtip.qtip-switch {
            max-width: 850px;
	        min-width: 300px;
        }
        .qtip.qtip-host {
            max-width: 500px;
	        min-width: 300px;
        }
        .datatable-center {
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="cy"></div>

<!-- jQuery -->
<script src="../bower_components/jquery/dist/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

<!-- Metis Menu Plugin JavaScript -->
<script src="../bower_components/metisMenu/dist/metisMenu.min.js"></script>

<!-- DataTables JavaScript -->
<script src="../bower_components/datatables/media/js/jquery.dataTables.min.js"></script>
<script src="../bower_components/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="../dist/js/sb-admin-2.js"></script>

<!-- Page-Level Demo Scripts - Tables - Use for reference -->
<script src="../js/querystringparser.js"></script>
<script src="../js/jquery.cookie.js"></script>

<!-- Custom scripts to load in HTML -->
<script src="../js/navbar.js"></script>
<script src="../bower_components/cytoscape/dist/cytoscape.js"></script>
<script src="../bower_components/qtip2/jquery.qtip.min.js"></script>
<link href="../bower_components/qtip2/jquery.qtip.min.css" rel="stylesheet" type="text/css" />
<script src="../bower_components/cytoscape-qtip/cytoscape-qtip.js"></script>

<script type="text/javascript">
    /*
     * These cookies are set on the login page at login.html.
     * They are simply the IP address of your controller and the REST api port.
     */

    var ipaddress = $.cookie('cip');
    if (ipaddress == null || ipaddress == "") window.location.href = "login.html";
    var restport = $.cookie('cport');
    if (restport == null || restport == "") window.location.href = "login.html";

    /* Declare some constant values for the types of nodes we can add */
    var NODE_SWITCH = "SWITCH";
    var NODE_HOST = "HOST";

    /* Define some constants for background colour */
    var SWITCH_BG = "#CE4345";
    var HOST_BG = "#589DFE";

    /* Contant for length of MAC in string form */
    var MAC_LEN = 17;

    var cyto = null;

    /* Cache for bandwidth values */
    var bandwidth = [];

    /* TODO: Need a method to fill these values, it should probably
     *       use the websocket to send a request? maybe get rid of them
     *       and pass directly into a creation function
     */
    var nodes = [];
    var edges = [];

    /*
    * This function draws the network and assigns actions to it as well.
    **/
    /* TODO: I would like to delete this method entirely maybe even add
             the loading into the ready function */
    function draw() {
        cyto = cytoscape({
            container: document.getElementById("cy"),
            elements: {
                nodes: nodes,
                edges: edges
            },
            /* Set the CSS styles for the graph */
            style: cytoscape.stylesheet()
                /* Node CSS */
                .selector('node').css({
                    /* Select the shape of the node based off the type */
                    'shape': function(ele) {
                        if (ele.data('type') == NODE_SWITCH) {
                            return "roundrectangle";
                        } else {
                            return "ellipse";
                        }
                    },

                    /* Set the background colour based on the type */
                    'background-color': function(ele) {
                        if (ele.data('type') == NODE_SWITCH) {
                            return SWITCH_BG;
                        } else {
                            return HOST_BG;
                        }
                    },

                    /* Set the background image using rendered FA icons */
                    'background-image': function(ele) {
                        if (ele.data('type') == NODE_SWITCH) {
                            return ("../bower_components/Font-Awesome-SVG-PNG/black/png/128/random.png");
                        } else {
                            return ("../bower_components/Font-Awesome-SVG-PNG/black/png/128/desktop.png");
                        }
                    },

                    /* Need to scale the background image for hosts more
                     * than the one for switches because of the shape
                     */
                    'background-width': function(ele) {
                        if (ele.data('type') == NODE_SWITCH) {
                            return '80%';
                        } else {
                            return '70%';
                        }
                    },


                    /* Same for the vertical position */
                    'background-position-y': function(ele) {
                        if (ele.data('type') == NODE_SWITCH) {
                            return '50%';
                        } else {
                            return '60%';
                        }
                    },

                    /* Same for the height */
                    'background-height': function(ele) {
                        if (ele.data('type') == NODE_SWITCH) {
                            return '80%';
                        } else {
                            return '70%';
                        }
                    },

                    /* Change border color by background color */
                    'border-color': function(ele) {
                        if (ele.data('type') == NODE_SWITCH) {
                            return '#510001';
                        } else {
                            return '#08264B';
                        }
                    },
                    'border-width': 5,
                    'border-opacity': 0.6,
                    'font-family': 'FontAwesome',
                    'font-style': 'normal',
                    'font-size': '20',
                    'text-valign': 'bottom',
                    'text-wrap': 'wrap',
                    'height': 64,
                    'width': 64
                })
                .selector('edge').css({
                    'width': function(ele) {
                        return (ele.data('weight'));
                    },
                    /* TODO: Need to find a way to make this include a range
                     *       with green -> yellow because going green -> red
                     *       is real ugly.
                     */
                    'line-color': 'mapData(weight, 5, 15, orange, red)',
                    'target-arrow-shape': 'triangle',
                    'opacity': 0.7
                 }),
            minZoom: 0.5,
            maxZoom: 5,
            wheelSensitivity: 0.2,
            boxSelectionEnabled: true,
            ready: function() {}
        })
    }

    /**
    * Loads the host information to the pop-up created after clicking on
    * the host.
    * TODO: This stuff should be changed to use query params on popup pages
    *
    * @param {String} host - ID of the host that was clicked
    */
    function loadHostPopup(api, host) {
        /* Load the popup HTML and set it in the QTIP window */
        $.ajax({
            url: "hostpopup.html",
            dataType: "html",
            success: function(html) {
                /* Parse HTML string into real HTML and add it to window */
                var $html = $('<div/>', {html: html});
                api.set('content.text', $html.html());

                /* Need to make another call that will load the link table and device info */
                $.ajax({
                    url: "http://" + ipaddress + ":" + restport + "/wm/device/",
                    success: function(data) {
                        /* Have to search for our MAC in the list */
                        var device = null;
                        for (var i = 0; i < data['devices'].length; i++) {
                            if (data['devices'][i]['mac'][0] == host) {
                                device = data['devices'][i];
                                break;
                            }
                        }

                        /* Check that we found the device or exit if we didn't */
                        if (!device) {
                            console.log("Could not find connected host: " + host);
                            return;
                        }

                        /* Set the fields in the info tab */
                        /* TODO: Format the date with 2 spaces (5 becomes 05) */
                        var d = new Date(device['lastSeen']);
                        $("#hostPopupIP").html(device['ipv4'].length ? device['ipv4'][0] : device['ipv6'][0]);
                        $("#hostPopupMAC").html(host);
                        $("#hostPopupLastSeen").html(d.getDate() + "/" + d.getMonth() + "/" + d.getFullYear() + " " + d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds());

                        /* Add links to the link table */
                        var t = $("#hostPopupLinksTable").DataTable({
                            /* TODO: Need to look into scrolling feature */
                            info: false,
                            searching: false,
                            lengthChange: false,
                            paging: false,
                            data: device["attachmentPoint"],
                            columns: [
                                {
                                    data: null,
                                    sortable: false,
                                    sClass: 'datatable-center',
                                    render: function (data, type, row, meta) {
                                        return meta.row + meta.settings._iDisplayStart + 1;
                                    }
                                },
                                {
                                    data: 'switch',
                                    sClass: 'datatable-center'
                                },
                                {
                                    data: 'port',
                                    sClass: 'datatable-center'
                                }
                            ]
                        });
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.error(jqXHR.responseText);
                    }
                });
            }
        });
    }

    /**
    * Function that will load the switch popup data and display it after
    * clicking on a switch.
    */
    function loadSwitchPopup(api, s) {

    }

    function loadSwitches() {
        /**
         * Loads the switches from the controller and adds them
         * to the cytoscape graph.
         */
        $.ajax({
            url: "http://" + ipaddress + ":" + restport + "/wm/core/controller/switches/json",

            /* On success add each switch as a node in the graph */
            success: function (data) {
                /* Add all the nodes from the JSON into a list */
                var nodes = [];
                for (var i = 0; i < data.length; i++) {
                    nodes.push({
                        group: "nodes",
                        data: {
                            id: data[i]["switchDPID"],
                            name: data[i]["switchDPID"],
                            type: NODE_SWITCH
                        }
                    });
                }

                /* Add the list to the cytoscape graph */
                cyto.add(nodes);

                /* Add tool-tips that appear on clicks */
                cyto.on("tap", "node[type = 'SWITCH']", function (event) {
                    var src = event.target.id();
                    event.target.qtip({
                        content: function (event, api) {
                            $.ajax({
                                url: "switchpopup.html",
                                dataType: "html",
                                success: function(html) {
                                    var $html = $('<div/>', {html: html});
                                    api.set('content.text', $html.html());
                                },
                                error: function (jqXHR, textStatus, errorThrown) {
                                    console.error(jqXHR.responseText);
                                }
                            }).then(function (html) {
                                $.ajax({
                                    url: "http://" + ipaddress + ":" + restport + "/wm/core/switch/" + src + "/flow/json",
                                    success: function (dat) {
                                        $("#switchPopupFlowTable").DataTable({
                                            /* TODO: Need to look into scrolling feature */
                                            info: false,
                                            searching: false,
                                            lengthChange: false,
                                            paging: false,
                                            data: dat["flows"],
                                            columns: [
                                                {data: 'table_id'},
                                                {data: 'packet_count'},
                                                {data: 'byte_count'},
                                                {data: 'duration_sec'},
                                                {data: 'priority'},
                                                {data: 'idle_timeout_s'},
                                                {data: 'hard_timeout_s'},
                                                {data: 'flags'},
                                                {data: 'instructions.instruction_apply_actions.actions'}
                                            ]
                                        });
                                    },
                                    error: function (jqXHR, textStatus, errorThrown) {
                                        console.error(jqXHR.responseText);
                                    }
                                });
                            });
                        },
                        overwrite: false,
                        show: {
                            solo: true
                        },
                        hide: {
                            fixed: true,
                            when: {
                                event: 'click'
                            }
                        },
                        events: {
                            /*
                            * When told to hide, we should just destroy the pop-up so we can
                            * re-create it later (so that DataTable does not complain)
                            */
                            hide: function(event, api) {
                                api.destroy(true);
                            }
                        },
                        position: {
                            my: 'bottom center',
                            at: 'top center'
                        },
                        style: {
                            classes: 'qtip-bootstrap qtip-switch',
                            tip: {
                                width: 16,
                                height: 8
                            }
                        }
                    }, event);
                });
            },

            /* If theres an error retrieving the switches log the error */
            error: function (jqXHR, textStatus, errorThrown) {
                console.error(jqXHR.responseText);
                alert('Error: ' + " " + jqXHR.responseText + " \n Status: " +
                      textStatus + " \n Error Thrown: " + errorThrown);
            }
        });
    }

    function loadInternalLinks() {
        /**
         * Loads all the links between switches which are defined as an
         * "internal" link.
         *
         * @see: http://127.0.0.1:8080/wm/topology/links/json
         */

         $.ajax({
             url: "http://" + ipaddress + ":" + restport + "/wm/topology/links/json",

             /* If we can get the data from the REST API */
             success: function (links) {
                 /* For each link we need to add an edge between the switches */
                 edges = [];
                 for (var i = 0; i < links.length; i++) {
                     edges.push({
                         group: "edges",
                         data: {
                             id: links[i]["src-switch"] + "_" + links[i]["dst-switch"],
                             source: links[i]["src-switch"],
                             target: links[i]["dst-switch"],
                             weight: 10
                         }
                     })
                 }

                 /* Add the data to the cytoscape graph */
                 cyto.add(edges);
             }
         });
    }

    function loadHosts() {
        /**
         * Loads all the hosts from the controller and adds them to the
         * cytoscape graph.
         */
        $.ajax({
            url: "http://" + ipaddress + ":" + restport + "/wm/device/",

            success: function (hosts) {
                data = [];
                hosts = hosts.devices;
                for (var i = 0; i < hosts.length; i++) {
                    if (hosts[i]["attachmentPoint"].length > 0) {
                        data.push({
                            group: "nodes",
                            data: {
                                id: hosts[i]["mac"][0],
                                name: hosts[i]["mac"][0],
                                type: NODE_HOST
                            }
                        });
                    }

                    /* Parse all the links between hosts <-> switches */
                    for (var j = 0; j < hosts[i]["attachmentPoint"].length; j++) {
                        data.push({
                            group: "edges",
                            data: {
                                id: hosts[i]["attachmentPoint"][j]["switch"] + "_" + hosts[i]["mac"][0],
                                source: hosts[i]["mac"][0],
                                target: hosts[i]["attachmentPoint"][j]["switch"],
                                weight: 10
                            }
                        })
                    }

                    /* Add the data to the cytoscape graph */
                    cyto.add(data);
                }

                cyto.layout({
                    name: 'cose',
                    gravity: -10,
                    initialTemp: 100000,
                    nodeRepulsion: function(node) {
                        return 100000;
                    },
                    fit: true
                }).run();

                /* Add the edge pop-up */
                cyto.on("tap", "edge", function (event) {
                    var src = event.target.id().split("_")[0];
                    var dst = event.target.id().split("_")[1];

                    event.target.qtip({
                        content: function (event, api) {
                            $.ajax({
                                url: 'linkpopup.html',
                                dataType: "html"
                            }).then(function (html) {
                                var $html = $('<div/>', {html:html});
                                $.ajax({
                                    url: "http://" + ipaddress + ":" + restport + "/wm/statistics/bandwidth/" + src + "/1/json",
                                    dataType: "json",
                                    success: function(data) {
                                        $html.find("#popup-capacity").html(formatSpeed(data[0]["link-speed-bits-per-second"]));

                                        /* Calculate overall bandwidth */
                                        var bandwidth = parseInt(data[0]["bits-per-second-rx"]) + parseInt(data[0]["bits-per-second-tx"]);
                                        $html.find("#popup-bandwidth").html(formatSpeed(bandwidth));
                                        api.set('content.text', $html.html());
                                    },

                                    error: function (jqXHR, textStatus, errorThrown) {
                                        console.error(jqXHR.responseText);
                                        alert('Error: ' + " " + jqXHR.responseText + " \n Status: " +
                                              textStatus + " \n Error Thrown: " + errorThrown);
                                    }
                                });

                                $.ajax({
                                    url: "http://" + ipaddress + ":" + restport + "/wm/core/switch/" + src + "/flow/json",
                                    dataType: "json",
                                    success: function(data) {
                                        console.log(data.flows[0]);
                                        $html.find("#popup-packet-count").html(data.flows[0]["packet_count"]);
                                        $html.find("#popup-data-count").html(formatSize(data.flows[0]["byte_count"]));
                                        api.set('content.text', $html.html());
                                    },

                                    error: function (jqXHR, textStatus, errorThrown) {
                                        console.error(jqXHR.responseText);
                                        alert('Error: ' + " " + jqXHR.responseText + " \n Status: " +
                                              textStatus + " \n Error Thrown: " + errorThrown);
                                    }
                                });
                            });
                        },
                        show: {
                            solo: true
                        },
                        hide: {
                            fixed: true,
                            when: {
                                event: 'click'
                            }
                        },
                        position: {
                            my: 'bottom center',
                            at: 'top center'
                        },
                        style: {
                            classes: 'qtip-bootstrap qtip-host',
                            tip: {
                                width: 16,
                                height: 8
                            }
                        }
                    }, event);
                });

                cyto.on("tap", "node[type = 'HOST']", function (event) {
                    var src = event.target.id();
                    event.target.qtip({
                        content: function (event, api) {
                            loadHostPopup(api, src);
                        },

                        /* If there was an error log and show pop-up */
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.log(jqXHR.responseText);
                            alert('Error: ' + " " + jqXHR.responseText + " \n Status: " +
                                  textStatus + " \n Error Thrown: " + errorThrown);
                        },

                        overwrite: false,
                        show: {
                            solo: true
                        },
                        hide: {
                            fixed: true,
                            when: {
                                event: 'click'
                            }
                        },
                        events: {
                            /*
                            * When told to hide, we should just destroy the pop-up so we can
                            * re-create it later (so that DataTable does not complain)
                            */
                            hide: function(event, api) {
                                api.destroy(true);
                            }
                        },
                        position: {
                            my: 'bottom center',
                            at: 'top center'
                        },
                        style: {
                            classes: 'qtip-bootstrap qtip-host',
                            tip: {
                                width: 16,
                                height: 8
                            }
                        }
                    }, event);
                });
            }
        });
    }

    /*
     * Helper function to convert bytes to a string with correct units.
     * */
    function formatSpeed(bytes) {
        if (bytes >= 1000000000) {
            bytes = (bytes / 1000000000).toFixed(2) + ' Gbps';
        }
        else if (bytes >= 1000000) {
            bytes = (bytes / 1000000).toFixed(2) + ' Mbps';
        }
        else if (bytes >= 1000) {
            bytes = (bytes / 1000).toFixed(2) + ' Kbps';
        }
        else if (bytes > 1) {
            bytes = bytes + ' bps';
        }
        else if (bytes == 1) {
            bytes = bytes + ' bps';
        }
        else {
            bytes = '0 bps';
        }
        return bytes;
    }

    function formatSize(bytes) {
        if (bytes >= 1000000000) {
            bytes = (bytes / 1000000000).toFixed(2) + ' GB';
        }
        else if (bytes >= 1000000) {
            bytes = (bytes / 1000000).toFixed(2) + ' MB';
        }
        else if (bytes >= 1000) {
            bytes = (bytes / 1000).toFixed(2) + ' KB';
        }
        else if (bytes > 1) {
            bytes = bytes + ' bytes';
        }
        else if (bytes == 1) {
            bytes = bytes + ' byte';
        }
        else {
            bytes = '0 bytes';
        }
        return bytes;
    }

    /* TODO: Need to make add more efficient by only adding once */
    draw();
    loadSwitches();
    loadInternalLinks();
    loadHosts();
</script>
</body>
</html>
